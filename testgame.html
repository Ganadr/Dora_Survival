<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dora-Survivor: Bio-Warfare</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #58a6ff;
            --alert-color: #ff7b72;
            --success-color: #3fb950;
            --border-color: #30363d;
            --panel-bg: #161b22;
            --highlight: #f2cc60;
            --rare: #a371f7;
            --legendary: #ffdd57;
        }
        body { font-family: 'Consolas', 'Courier New', monospace; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; font-size: 14px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .dashboard { grid-template-columns: 1fr; } }

        .box { border: 1px solid var(--border-color); background: var(--panel-bg); padding: 15px; border-radius: 6px; position: relative; }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; color: #fff; font-size: 16px; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-val { font-weight: bold; color: #fff; }
        
        .trait-tag { display: inline-block; background: #238636; color: white; padding: 3px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; margin-bottom: 4px; border: 1px solid rgba(255,255,255,0.2); }
        
        #log-area { height: 200px; overflow-y: auto; font-size: 13px; color: #8b949e; border: 1px solid var(--border-color); padding: 10px; background: #000; }
        .log-new { color: var(--success-color); }
        .log-danger { color: var(--alert-color); }
        .log-boss { color: var(--rare); font-weight: bold; }
        
        .enemy-container { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px; }
        .enemy-card { 
            border: 2px solid var(--border-color); padding: 10px; min-width: 140px; border-radius: 6px; background: #2a0a0a; 
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .enemy-card:hover { border-color: #8b949e; }
        .enemy-card.selected { border-color: var(--highlight); background: #3e3820; }
        .enemy-card.boss { border-color: var(--rare); background: #2a0e38; box-shadow: 0 0 10px var(--rare); }
        .enemy-card.dead { opacity: 0.3; pointer-events: none; filter: grayscale(100%); }
        .enemy-name { color: var(--alert-color); font-weight: bold; display: block; margin-bottom: 5px;}
        .enemy-hp-bar { height: 4px; background: #555; margin: 5px 0; border-radius: 2px; }
        .enemy-hp-fill { height: 100%; background: var(--alert-color); width: 100%; transition: width 0.3s; }

        .quest-bar-container { background: #222; height: 10px; border-radius: 5px; margin-top: 5px; border: 1px solid #555; }
        .quest-bar-fill { background: var(--highlight); height: 100%; width: 0%; transition: width 0.5s; }

        .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        button { background: #21262d; color: #c9d1d9; border: 1px solid var(--border-color); padding: 12px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button:hover { background: #30363d; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gadget { color: var(--highlight); border-color: #9e8c43; }
        .btn-gadget:hover { background: #3e3820; }
        
        .hidden { display: none !important; }
        
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--panel-bg); border: 2px solid var(--success-color); padding: 20px; width: 85%; max-width: 500px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .evo-option { display: block; width: 100%; margin: 10px 0; padding: 15px; border: 1px solid var(--success-color); background: #0d1117; color: var(--success-color); cursor: pointer; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div class="box" style="text-align: center; border-color: var(--highlight);">
        <h2 style="color: var(--highlight); margin:0;">DORA-SURVIVOR: BIO-WARFARE</h2>
    </div>

    <div class="dashboard">
        <div class="box">
            <h3>üë§ Ng∆∞·ªùi S·ªëng S√≥t</h3>
            <div class="stat-row"><span>HP:</span> <span class="stat-val" id="p-hp">100/100</span></div>
            <div class="stat-row"><span>ATK:</span> <span class="stat-val" id="p-atk">15</span></div>
            <div class="stat-row"><span>DEF:</span> <span class="stat-val" id="p-def">5</span></div>
            <div class="stat-row"><span>SPD:</span> <span class="stat-val" id="p-spd">10</span></div>
            <div style="margin-top:10px; border-top:1px dashed #555; padding-top:5px;">
                <div class="stat-row"><span>üß¨ Gen:</span> <span class="stat-val" id="p-gen">0</span></div>
                <div class="stat-row"><span>üì¶ Kho:</span> <span class="stat-val" id="p-inventory">Th·ªãt: 2, Thu·ªëc: 1</span></div>
            </div>
            
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <small>ƒê·∫∑c t√≠nh:</small>
                <button onclick="showTraits()" style="padding: 2px 8px; font-size: 11px; width: auto; background: #222; border: 1px solid #555;">üëÅÔ∏è Chi ti·∫øt</button>
            </div>
            <div id="p-traits" style="margin-top: 5px;">Ch∆∞a c√≥ ƒë·∫∑c t√≠nh</div>
        </div>

        <div class="box">
            <h3>üöÄ Nhi·ªám V·ª•: S·ª≠a C·ªó M√°y</h3>
            <div class="stat-row"><span>üìÖ Ng√†y sinh t·ªìn:</span> <span class="stat-val" id="g-day">1</span></div>
            <div class="stat-row"><span>üß© Linh ki·ªán:</span> <span class="stat-val" id="g-parts">0/5</span></div>
            <div class="quest-bar-container">
                <div class="quest-bar-fill" id="quest-bar"></div>
            </div>
            <p id="next-event" style="font-size: 12px; color: #8b949e; margin-top: 10px;">
                S·ª± ki·ªán ti·∫øp theo: Boss xu·∫•t hi·ªán v√†o Ng√†y 10.
            </p>
            
            <div id="combat-area" class="hidden" style="margin-top: 10px; border-top: 1px solid #333; padding-top:10px;">
                <small style="color: #ff7b72;">‚ö†Ô∏è ƒêANG GIAO CHI·∫æN! (Ch·ªçn m·ª•c ti√™u)</small>
                <div class="enemy-container" id="e-list"></div>
            </div>
        </div>
    </div>

    <div id="log-area">
        <div>> Kh·ªüi ƒë·ªông nh·∫≠t k√Ω sinh t·ªìn...</div>
        <div>> M·ª•c ti√™u: Thu th·∫≠p 5 linh ki·ªán t·ª´ c√°c Boss (xu·∫•t hi·ªán m·ªói 10 ng√†y).</div>
    </div>

    <div class="box">
        <div id="mode-explore" class="action-grid">
            <button onclick="explore()">üìÖ TI·∫æN T·ªöI 1 NG√ÄY (Th√°m hi·ªÉm)</button>
            <button onclick="rest()">‚õ∫ NGH·ªà NG∆†I (H·ªìi m√°u, ƒÇn th·ªãt)</button>
            <button onclick="useMedkit()">üß∞ D√ôNG THU·ªêC (H·ªìi m√°u nhanh)</button>
            <button class="btn-gadget" onclick="useTablecloth()">üçΩÔ∏è KHƒÇN TR·∫¢I B√ÄN (Gen -> Th·ªãt)</button>
            <button onclick="openEvo()" id="btn-evo" style="grid-column: span 2; border-color: #3fb950; color: #3fb950;">üß¨ D√ôNG S√öNG TI·∫æN H√ìA (50 Gen)</button>
        </div>

        <div id="mode-combat" class="action-grid hidden">
            <button onclick="performAction('basic')">‚öîÔ∏è T·∫§N C√îNG TH∆Ø·ªúNG</button>
            <button class="btn-gadget" onclick="performAction('air_cannon')">üí• ƒê·∫°i B√°c Kh√¥ng Kh√≠(DMG Cao)</button>
            <button class="btn-gadget" onclick="performAction('dictator_switch')">‚ò†Ô∏è C√¥ng T·∫Øc ƒê·ªôc T√†i(X√≥a S·ªï - No Loot)</button>
            <button class="btn-gadget" onclick="performAction('evo_gun_enemy')">üî´ S√∫ng Ti·∫øn H√≥a (Debuff/X√≥a trait)</button>
            <button class="btn-gadget" onclick="performAction('counter_mantle')">üõë KhƒÉn Cho√†ng A-l√™-h·∫•p (Ch·∫∑n)</button>
            <button class="btn-gadget" onclick="performAction('anywhere_door')">üö™ C·ª≠a Th·∫ßn K·ª≥ (Ch·∫°y)</button>
        </div>
    </div>
</div>

<div id="modal-overlay" class="hidden">
    <div class="modal-content">
        <h3 id="modal-title" style="color: #3fb950;">TH√îNG B√ÅO</h3>
        <p id="modal-desc" style="color: #8b949e; font-size: 13px;">N·ªôi dung</p>
        <div id="modal-body"></div>
        <button onclick="closeModal()" id="btn-close-modal" style="margin-top:20px; width:100%;">ƒê√≥ng</button>
    </div>
</div>

<script>
    
    /* --- DATA: SINH H·ªåC --- */
    const PARTS_DB = {
        ATK: [
            { name: "Vu·ªët", tag: "MELEE" }, { name: "Nanh", tag: "DRAIN" }, { name: "Gai", tag: "THORNS" }, 
            { name: "ƒêu√¥i", tag: "MELEE" }, { name: "S·ª´ng", tag: "MELEE" }, { name: "X√∫c Tu", tag: "MELEE" }
        ],
        DEF: [
            { name: "Da", tag: "SKIN" }, { name: "V·ªè", tag: "ARMOR" }, { name: "X∆∞∆°ng", tag: "SKELETON" }, { name: "V·∫£y", tag: "ARMOR" }
        ],
        HP:  [
            { name: "Tim", tag: "CORE" }, { name: "M√°u", tag: "FLUID" }, { name: "T·∫ø B√†o", tag: "CELL" }
        ],
        SPD: [
            { name: "C√°nh", tag: "FLIGHT" }, { name: "Ch√¢n", tag: "MOVE" }, { name: "M·∫Øt", tag: "SIGHT" }
        ]
    };

    const TIERS_DB = [
        { name: "C∆∞·ªùng Ho√°", mod: 1.0, rare: 1, element: "NONE" }, 
        { name: "G·ªó H√≥a", mod: 1.1, rare: 2, element: "HARD" },
        { name: "L·ª≠a", mod: 1.3, rare: 2, element: "FIRE" },   
        { name: "BƒÉng", mod: 1.3, rare: 2, element: "ICE" },   
        { name: "ƒê·ªôc", mod: 1.2, rare: 2, element: "POISON" }, 
        { name: "Huy·∫øt", mod: 1.4, rare: 3, element: "BLOOD" },
        { name: "Tinh Th·ªÉ", mod: 1.8, rare: 3, element: "HARD" }, 
        { name: "H·∫°t Nh√¢n", mod: 2.2, rare: 4, element: "RADIOACTIVE" }, 
        { name: "H∆∞ Kh√¥ng", mod: 2.5, rare: 4, element: "VOID" },
        { name: "V≈© Tr·ª•", mod: 3.0, rare: 5, element: "COSMIC" }
    ];

    const ENTITIES = ["Zombie", "Chu·ªôt", "Gi√°n", "S√≥i", "Ng∆∞·ªùi M√°y", "C√¢y ƒê·ªôt Bi·∫øn", "Th·∫±n L·∫±n"];
    const BOSS_NAMES = ["Kh·ªïng L·ªì M·ªôt M·∫Øt", "B·∫°ch Tu·ªôc Kh√¥ng Gian", "M√°y Ch√©m R·ªâ S√©t", "S√≥i Alpha ƒê·ªôt Bi·∫øn"];
    const FINAL_BOSS = "VUA H·ª¶Y DI·ªÜT";

    // --- C·∫¨P NH·∫¨T: Th√™m Boss v√†o Loot Table ƒë·ªÉ th∆∞·ªüng to h∆°n ---
    const LOOT_TABLE = {
        "Zombie": { meat: 0.8, gen: 10, med: 0.05 },
        "Chu·ªôt":  { meat: 0.7, gen: 5,  med: 0.05 },
        "Gi√°n":   { meat: 0.2, gen: 5,  med: 0.05 },
        "S√≥i":    { meat: 1.0, gen: 15, med: 0.0 },
        "Th·∫±n L·∫±n": { meat: 0.9, gen: 10, med: 0.0 },
        "Ng∆∞·ªùi M√°y": { meat: 0.0, gen: 40, med: 0.1 }, 
        "C√¢y ƒê·ªôt Bi·∫øn": { meat: 0.1, gen: 10, med: 0.4 },
        
        // --- Th√™m BOSS ---
        "Kh·ªïng L·ªì M·ªôt M·∫Øt": { meat: 1.0, gen: 100, med: 0.3 },
        "B·∫°ch Tu·ªôc Kh√¥ng Gian": { meat: 1.0, gen: 120, med: 0.3 },
        "M√°y Ch√©m R·ªâ S√©t": { meat: 0.0, gen: 150, med: 0.3 }, // Nhi·ªÅu Gen
        "S√≥i Alpha ƒê·ªôt Bi·∫øn": { meat: 1.0, gen: 120, med: 0.3 },
        "VUA H·ª¶Y DI·ªÜT": { meat: 1.0, gen: 500, med: 1.0 } // Tr√πm cu·ªëi
    };

    let player = {
        hp: 100, maxHp: 100, atk: 15, def: 5, spd: 10, regen: 0, 
        genPoints: 0, items: { meat: 3, medkit: 1 }, 
        traits: [], days: 1, parts: 0
    };

    let currentEnemies = [];
    let isCountering = false;
    let isBossFight = false;

    /* --- UTILITIES --- */
    function log(msg, type = "info") {
        const div = document.getElementById("log-area");
        div.innerHTML += `<div class="${type==="danger"?"log-danger":type==="new"?"log-new":type==="boss"?"log-boss":"log-info"}">> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }
    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    
    function toggleInput(disabled) {
        const buttons = document.querySelectorAll('#mode-combat button');
        buttons.forEach(btn => {
            btn.disabled = disabled;
            btn.style.opacity = disabled ? "0.5" : "1";
            btn.style.cursor = disabled ? "not-allowed" : "pointer";
        });
    }

    /* --- TRAIT GENERATOR --- */
    function generateSynergyTrait(forceTier = null) {
        let r = Math.random();
        let type = "ATK";
        if (r < 0.3) type = "ATK"; else if (r < 0.6) type = "DEF"; else if (r < 0.85) type = "HP"; else if (r < 0.95) type = "SPD"; else type = "REGEN";

        let desc = "", finalVal = 0, passive = null, fullName = "";

        if (type === "REGEN") {
            let val = 4;
            let rareMod = rand(1, 3);
            finalVal = val * rareMod;
            fullName = "T·∫ø B√†o T√°i Sinh" + (rareMod > 1 ? ` Mk.${rareMod}` : "");
            desc = `H·ªìi ${finalVal} HP/l∆∞·ª£t`;
        } else {
            let partList = PARTS_DB[type];
            let part = partList[Math.floor(Math.random() * partList.length)];

            let tierList = forceTier ? [forceTier] : TIERS_DB;
            if (!forceTier) {
                let rt = Math.random();
                tierList = TIERS_DB.filter(t => t.rare <= (rt < 0.6 ? 1 : rt < 0.9 ? 2 : rt < 0.98 ? 3 : 5));
            }
            let prefix = pickRandom(tierList);

            let baseVal = (type==="HP"?20 : type==="ATK"?8 : 5);
            
            if (prefix.name === "C∆∞·ªùng Ho√°") {
                let bonusPercent = rand(1, 15);
                finalVal = Math.floor(baseVal * (1 + bonusPercent/100));
                if (finalVal <= baseVal) finalVal = baseVal + 1; 
                desc = `${type} +${finalVal} (C∆∞·ªùng ho√° ${bonusPercent}%)`;
            } else {
                finalVal = Math.floor(baseVal * prefix.mod * ((Math.random()*0.4)+0.8));
                desc = `${type} +${finalVal}`;
            }
            finalVal = Math.max(1, finalVal);

            let passiveDesc = "";
            if (prefix.element === "FIRE" && part.tag === "MELEE") { passive = "BURN"; passiveDesc = " (Ch√°y +5 DMG)"; }
            else if (prefix.element === "BLOOD" && part.tag === "DRAIN") { passive = "LIFESTEAL"; passiveDesc = " (H√∫t 20% HP)"; }
            else if (prefix.element === "POISON" && (part.tag === "THORNS" || part.tag === "SKIN")) { passive = "POISON_SKIN"; passiveDesc = " (Ph·∫£n ƒë·ªôc)"; }
            else if (prefix.element === "VOID" && type === "ATK") { passive = "PIERCE"; passiveDesc = " (Xuy√™n 50% Gi√°p)"; }
            else if (prefix.element === "RADIOACTIVE" && part.tag === "CORE") { passive = "REACTOR"; passiveDesc = " (H·ªìi Gen, Tr·ª´ M√°u)"; }
            else if (prefix.element === "ICE" && type === "SPD") { passive = "FREEZE_AURA"; passiveDesc = " (Gi·∫£m T·ªëc ƒê·ªãch)"; }

            fullName = `${part.name} ${prefix.name}`;
            desc += passiveDesc;
        }

        return { name: fullName, type: type, val: finalVal, desc: desc, passive: passive };
    }

    /* --- UI UPDATE --- */
    function updateUI() {
        document.getElementById("p-hp").innerText = `${Math.max(0, player.hp)}/${player.maxHp}`;
        document.getElementById("p-atk").innerText = player.atk;
        document.getElementById("p-def").innerText = player.def;
        document.getElementById("p-spd").innerText = player.spd;
        document.getElementById("p-gen").innerText = player.genPoints;
        document.getElementById("p-inventory").innerText = `Th·ªãt: ${player.items.meat}, Thu·ªëc: ${player.items.medkit}`;
        
        document.getElementById("p-traits").innerHTML = player.traits.map(t => {
            let style = t.passive ? 'border-color: #ffdd57; color: #ffdd57;' : '';
            return `<span class="trait-tag" style="${style}" title="${t.desc}">${t.name}</span>`
        }).join("") || "Kh√¥ng";
        
        document.getElementById("g-day").innerText = player.days;
        document.getElementById("g-parts").innerText = `${player.parts}/5`;
        document.getElementById("quest-bar").style.width = `${(player.parts/5)*100}%`;
        
        let nextBossDay = Math.ceil(player.days / 10) * 10;
        if (player.days % 10 === 0 && !isBossFight) nextBossDay += 10; 
        document.getElementById("next-event").innerText = `M·ª•c ti√™u k·∫ø ti·∫øp: Ng√†y ${nextBossDay} (C√≤n ${nextBossDay - player.days} ng√†y)`;

        document.getElementById("btn-evo").disabled = player.genPoints < 50;

        if (player.hp <= 0) {
            toggleInput(true); 
            showModal("B·∫†N ƒê√É T·ª¨ N·∫†N", "Th·∫ø gi·ªõi n√†y qu√° kh·∫Øc nghi·ªát. H√£y th·ª≠ l·∫°i.", true);
        }
    }

    function showTraits() {
        if (player.traits.length === 0) { showModal("H·ªí S∆† GEN", "Ch∆∞a c√≥ ƒë·∫∑c t√≠nh."); return; }
        let html = `<div style="text-align: left;">`;
        player.traits.forEach(t => {
            let color = t.passive ? '#ffdd57' : '#3fb950';
            html += `<div style="border:1px solid ${color};padding:8px;margin-bottom:5px;border-radius:4px;"><div style="color:${color};font-weight:bold">${t.name}</div><div style="font-size:12px;color:#ccc">${t.desc}</div></div>`;
        });
        html += `</div>`;
        showModal(`H·ªí S∆† GEN (T·ªïng: ${player.traits.length})`, "", false, html);
    }

    /* --- GAME LOOP --- */
    function explore() {
        if (player.items.meat <= 0 && player.hp < 20) { log("Qu√° ƒë√≥i v√† y·∫øu!", "danger"); return; }
        if (player.days % 10 === 0) { startCombat(true); return; }
        player.hp = Math.max(1, player.hp - 2); player.days++; updateUI();
        if (Math.random() > 0.35) startCombat(false); else findLoot();
    }
    function findLoot() {
        let r = rand(1, 100);
        if (r < 50) { player.items.meat += 2; log("T√¨m th·∫•y 2 Th·ªãt bi·∫øn d·ªã.", "new"); }
        else if (r < 80) { player.genPoints += 25; log("H·∫•p th·ª• ƒë∆∞·ª£c 25 Gen t·ª± do.", "new"); }
        else { player.items.medkit += 1; log("Tuy·ªát v·ªùi! T√¨m th·∫•y 1 H·ªôp C·ª©u Th∆∞∆°ng.", "new"); }
        updateUI();
    }

    /* --- COMBAT SYSTEM --- */
    function startCombat(bossMode) {
        isBossFight = bossMode; currentEnemies = []; isCountering = false; 
        if (bossMode) {
            let bossName = player.parts === 4 ? FINAL_BOSS : pickRandom(BOSS_NAMES);
            let m = 1.5 + (player.days / 20);
            let traits = []; for(let i=0; i<3; i++) traits.push(generateSynergyTrait(pickRandom(TIERS_DB.filter(t=>t.rare>=3))));
            currentEnemies.push({ id: 0, name: bossName, isBoss: true, stats: { hp: Math.floor(150*m), maxHp: Math.floor(150*m), atk: Math.floor(20*m), def: Math.floor(5*m), spd: Math.floor(8*m) }, traits: traits, alive: true, selected: false });
            log(`üî•üî• B√ÅO ƒê·ªòNG: ${bossName} XU·∫§T HI·ªÜN!`, "boss");
        } else {
            let count = rand(1, 3);
            for(let i=0; i<count; i++) {
                let m = 1 + (player.days / 50);
                let traits = []; let tc = rand(1, 2); for(let k=0; k<tc; k++) traits.push(generateSynergyTrait());
                let base = { hp: 40*m, maxHp: 40*m, atk: 10*m, def: 0, spd: 5 };
                traits.forEach(t => { if(t.type==="HP"){base.hp+=t.val;base.maxHp+=t.val;} if(t.type==="ATK")base.atk+=t.val; if(t.type==="DEF")base.def+=t.val; if(t.type==="SPD")base.spd+=t.val; });
                
                let name = pickRandom(ENTITIES);
                currentEnemies.push({ id: i, name: name, isBoss: false, stats: base, traits: traits, alive: true, selected: false });
            }
            log(`Ph√°t hi·ªán ${count} k·∫ª ƒë·ªãch ch·∫∑n ƒë∆∞·ªùng.`);
        }
        document.getElementById("mode-explore").classList.add("hidden"); document.getElementById("mode-combat").classList.remove("hidden"); document.getElementById("combat-area").classList.remove("hidden");
        toggleInput(false); renderEnemies();
    }
    function renderEnemies() {
        const div = document.getElementById("e-list"); div.innerHTML = "";
        currentEnemies.forEach(e => {
            let hpPct = (e.stats.hp / e.stats.maxHp) * 100;
            let el = document.createElement("div");
            el.className = `enemy-card ${e.isBoss ? 'boss' : ''} ${e.alive ? '' : 'dead'} ${e.selected ? 'selected' : ''}`;
            el.onclick = () => { if(e.alive) { currentEnemies.forEach(x => x.selected = false); e.selected = true; renderEnemies(); } };
            el.innerHTML = `<span class="enemy-name">${e.name}</span><div class="enemy-hp-bar"><div class="enemy-hp-fill" style="width:${hpPct}%"></div></div><small>HP: ${Math.ceil(e.stats.hp)} | ATK: ${Math.ceil(e.stats.atk)}</small><br><div style="margin-top:4px;">${e.traits.map(t=>`<span class="trait-tag">${t.name}</span>`).join("")}</div>`;
            div.appendChild(el);
        });
    }

    function performAction(type) {
        let targets = currentEnemies.filter(e => e.selected && e.alive);
        if (targets.length === 0 && currentEnemies.filter(e => e.alive).length === 1) targets = [currentEnemies.find(e => e.alive)];
        if (type !== 'anywhere_door' && type !== 'counter_mantle' && targets.length === 0) { log("H√£y ch·ªçn m·ª•c ti√™u!", "danger"); return; }
        toggleInput(true);

        if (type === 'counter_mantle') { isCountering = true; log("Tung KhƒÉn Cho√†ng A-l√™-h·∫•p!", "info"); setTimeout(enemiesTurn, 500); return; }
        
        if (type === 'anywhere_door') { 
            log("M·ªü C·ª≠a Th·∫ßn K·ª≥... Ch·∫°y tho√°t th√†nh c√¥ng!", "info"); 
            endCombat(false); 
            return; 
        }

        let t = targets[0], dmg = Math.max(1, player.atk - t.stats.def), turnEnded = true;
        switch(type) {
            case 'basic':
                if (player.traits.some(x => x.passive === "PIERCE")) { dmg = Math.max(1, player.atk - (t.stats.def/2)); log("Xuy√™n Gi√°p!", "success"); }
                if (player.traits.some(x => x.passive === "BURN")) { dmg += 5; log("Thi√™u ƒë·ªët +5 DMG!", "danger"); }
                if (player.traits.some(x => x.passive === "LIFESTEAL")) { let h = Math.ceil(dmg*0.2); player.hp = Math.min(player.maxHp, player.hp+h); log(`H√∫t ${h} HP!`, "new"); }
                t.stats.hp -= dmg; log(`T·∫•n c√¥ng ${t.name}: ${Math.floor(dmg)} ST.`); break;
            case 'air_cannon': t.stats.hp -= (Math.floor(dmg*2.5)+20); log(`ƒê·∫°i b√°c b·∫Øn ${t.name}: ST l·ªõn!`); break;
            case 'dictator_switch': if(t.isBoss)log("Boss mi·ªÖn nhi·ªÖm!","danger"); else if(confirm("X√≥a s·ªï (Kh√¥ng Loot)?")){t.stats.hp=0;t.noLoot=true;log(`${t.name} b·ªã x√≥a s·ªï.`,"danger");}else{turnEnded=false;toggleInput(false);} break;
            case 'evo_gun_enemy': 
                let mode = prompt("S√öNG TI·∫æN H√ìA:\n1. Tho√°i h√≥a (Gi·∫£m ch·ªâ s·ªë)\n2. T·∫©y Gen (X√≥a 1 ƒë·∫∑c t√≠nh c·ªßa ƒë·ªãch)", "1");
                if (mode === "1") {
                    t.stats.atk = Math.floor(t.stats.atk * 0.6); t.stats.def = Math.floor(t.stats.def * 0.6); t.stats.hp -= 15;
                    log(`Tho√°i h√≥a ${t.name}: Ch·ªâ s·ªë gi·∫£m m·∫°nh!`);
                } else if (mode === "2") {
                    if (t.traits.length > 0) {
                        let ridx = rand(0, t.traits.length-1);
                        let removed = t.traits.splice(ridx, 1)[0];
                        if(removed.type==="ATK") t.stats.atk-=removed.val;
                        if(removed.type==="DEF") t.stats.def-=removed.val;
                        if(removed.type==="HP"){t.stats.maxHp-=removed.val; t.stats.hp=Math.min(t.stats.hp, t.stats.maxHp);}
                        if(removed.type==="SPD") t.stats.spd-=removed.val;
                        log(`T·∫©y Gen ${t.name}: M·∫•t ƒë·∫∑c t√≠nh [${removed.name}]!`, "success");
                    } else log(`${t.name} kh√¥ng c√≤n Gen n√†o ƒë·ªÉ x√≥a!`, "danger");
                } else { turnEnded = false; toggleInput(false); }
                break;
        }
        if (turnEnded) { currentEnemies.forEach(e => { if(e.stats.hp<=0) e.alive=false; }); renderEnemies(); if(currentEnemies.every(e=>!e.alive)) endCombat(true); else setTimeout(enemiesTurn, 500); }
    }

    function enemiesTurn() {
        if(currentEnemies.every(e=>!e.alive)) { endCombat(true); return; }
        log("--- L∆∞·ª£t k·∫ª ƒë·ªãch ---", "info");
        let totalDmg = 0;
        currentEnemies.forEach(e => {
            if (e.alive) {
                if (isCountering) { let r = Math.floor(e.stats.atk*1.5); e.stats.hp-=r; log(`‚ú® A-l√™-h·∫•p! ƒê√≤n c·ªßa ${e.name} b·ªã h·∫•t ng∆∞·ª£c l·∫°i (${r} ST)!`,"success"); }
                else {
                    let d = Math.max(1, e.stats.atk - player.def);
                    let chance = (player.spd - e.stats.spd)*2;
                    if(player.traits.some(x=>x.passive==="FREEZE_AURA")) chance+=10;
                    if(Math.random()*100 < chance) log(`N√© ƒë∆∞·ª£c ƒë√≤n c·ªßa ${e.name}!`,"success");
                    else { 
                        if(player.traits.some(x=>x.passive==="POISON_SKIN")){e.stats.hp-=3;log(`${e.name} tr√∫ng ƒë·ªôc (-3 HP)`,"success");}
                        totalDmg+=d; log(`${e.name} g√¢y ${d} ST!`,"danger"); 
                    }
                }
            }
        });
        if(!isCountering) player.hp-=totalDmg; isCountering=false;
        if (player.hp <= 0) { log("‚ò†Ô∏è B·∫°n ƒë√£ g·ª•c ng√£...", "danger"); updateUI(); return; }
        if(player.traits.some(x=>x.passive==="REACTOR")){player.genPoints+=5;player.hp-=2;log("Tim H·∫°t Nh√¢n: +5 Gen, -2 HP","boss"); if(player.hp<=0){updateUI();return;}}
        currentEnemies.forEach(e => { if(e.stats.hp<=0) e.alive=false; }); renderEnemies(); updateUI();
        if(currentEnemies.every(e=>!e.alive)) endCombat(true); else toggleInput(false);
    }

    function endCombat(win) {
        toggleInput(false);
        if(!win) { document.getElementById("mode-explore").classList.remove("hidden"); document.getElementById("mode-combat").classList.add("hidden"); document.getElementById("combat-area").classList.add("hidden"); return; }
        
        let totalGen = 0, totalMeat = 0, totalMed = 0;
        let droppedPart = false;

        currentEnemies.forEach(e => {
            if (e.noLoot) return;
            
            // T√¨m trong b·∫£ng loot (ƒê√£ b·ªï sung Boss)
            let table = LOOT_TABLE[e.name] || { meat: 0.5, gen: 10, med: 0.0 };
            
            if (Math.random() < table.meat) totalMeat += 1;
            if (Math.random() < table.med) totalMed += 1;
            let gen = table.gen + rand(0, 5);

            // Bonus Trait
            e.traits.forEach(t => {
                if (t.name.includes("Huy·∫øt") || t.name.includes("M√°u")) { if (Math.random() < 0.5) totalMeat += 1; }
                if (t.name.includes("Tinh Th·ªÉ") || t.name.includes("G·ªó") || t.name.includes("S·∫Øt") || t.name.includes("Titan")) gen += 10;
                if (t.name.includes("H·∫°t Nh√¢n") || t.name.includes("V≈© Tr·ª•")) gen += 20;
            });

            totalGen += gen;
            if (e.isBoss) droppedPart = true;
        });

        player.genPoints += totalGen;
        player.items.meat += totalMeat;
        player.items.medkit += totalMed;

        if (player.regen > 0) player.hp = Math.min(player.maxHp, player.hp + player.regen);

        let msg = `Th·∫Øng! +${totalGen} Gen`;
        if (totalMeat > 0) msg += `, +${totalMeat} Th·ªãt`;
        if (totalMed > 0) msg += `, +${totalMed} Thu·ªëc`;
        log(msg, "new");

        if (droppedPart) { 
            player.parts++; 
            log(`üåü T√åM TH·∫§Y 1 LINH KI·ªÜN TH·ªúI GIAN! (${player.parts}/5)`, "boss"); 
            if (player.parts >= 5) {
                showModal("CHI·∫æN TH·∫ÆNG", "B·∫°n ƒë√£ s·ª≠a xong C·ªó M√°y Th·ªùi Gian v√† tr·ªü v·ªÅ nh√†!", true);
                return;
            } 
        }
        if (isBossFight) player.days++;
        document.getElementById("mode-explore").classList.remove("hidden"); document.getElementById("mode-combat").classList.add("hidden"); document.getElementById("combat-area").classList.add("hidden"); updateUI();
    }

    function rest() { if(player.items.meat>0){player.items.meat--;player.hp=Math.min(player.maxHp,player.hp+40);log("ƒÇn th·ªãt (+40 HP).","new");}else log("H·∫øt th·ªãt!","danger"); updateUI(); }
    function useMedkit() { if(player.items.medkit>0){player.items.medkit--;player.hp=Math.min(player.maxHp,player.hp+70);log("D√πng thu·ªëc (+70 HP).","new");}else log("H·∫øt thu·ªëc!","danger"); updateUI(); }
    function useTablecloth() { if(player.genPoints>=20){player.genPoints-=20;player.items.meat+=2;log("ƒê·ªïi 20 Gen -> 2 Th·ªãt.","new");}else log("C·∫ßn 20 Gen.","danger"); updateUI(); }
    function openEvo() { if(player.genPoints<50)return; let opts=[]; for(let i=0;i<3;i++)opts.push(generateSynergyTrait()); window.tempOpts=opts; document.getElementById("modal-title").innerText="TI·∫æN H√ìA"; document.getElementById("modal-desc").innerText="Ch·ªçn gen (-50 Gen):"; document.getElementById("modal-body").innerHTML=opts.map((t,i)=>`<button class="evo-option" onclick="doEvolve(${i})"><strong>${t.name}</strong><br><small>${t.desc}</small>${t.passive?`<br><span style="color:#ffdd57">‚òÖ ${t.passive}</span>`:''}</button>`).join(""); document.getElementById("btn-close-modal").innerText="H·ªßy"; document.getElementById("btn-close-modal").onclick=closeModal; document.getElementById("modal-overlay").classList.remove("hidden"); }
    function closeModal() { document.getElementById("modal-overlay").classList.add("hidden"); }
    function doEvolve(i) { let t=window.tempOpts[i]; player.genPoints-=50; player.traits.push(t); if(t.type==="HP"){player.maxHp+=t.val;player.hp+=t.val;} if(t.type==="ATK")player.atk+=t.val; if(t.type==="DEF")player.def+=t.val; if(t.type==="SPD")player.spd+=t.val; if(t.type==="REGEN")player.regen+=t.val; log(`Ti·∫øn h√≥a: ${t.name}`,"new"); updateUI(); closeModal(); }

    function showModal(title, msg, reload=false, customBody="") {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-desc").innerText = msg;
        document.getElementById("modal-body").innerHTML = customBody;
        document.getElementById("btn-close-modal").innerText = reload ? "Ch∆°i l·∫°i" : "ƒê√≥ng";
        document.getElementById("btn-close-modal").onclick = reload ? () => location.reload() : closeModal;
        document.getElementById("modal-overlay").classList.remove("hidden");
    }

    updateUI();

    //ƒë·ªìng minh, thu ph·ª•c, map
</script>

</body>
</html>
